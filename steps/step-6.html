<!DOCTYPE html>
<html>

<head>
  <title>Step 6 | CARTO VL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <script src="https://libs.cartocdn.com/carto-vl/v1.2/carto-vl.min.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://carto.com/developers/carto-vl/v1.2.6/examples/maps/style.css" rel="stylesheet">
</head>

<body>
  <div id="map"></div>
  <aside class="toolbox">
    <div class="box">
      <header>
        <h1>Crime Reports 2019</h1>
      </header>
      <section>
        <p class="description open-sans">Filter crime accidents by day</p>
      </section>
      <section>
        <div id="controls">
          <ul id="content"></ul>
        </div>
      </section>
      <footer class="js-footer"></footer>
    </div>
  </aside>
  <div id="loader">
    <div class="CDB-LoaderIcon CDB-LoaderIcon--big">
      <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
        <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
      </svg>
    </div>
  </div>
  <script>
    const map = new mapboxgl.Map({
      container: 'map',
      style: carto.basemaps.darkmatter,
      center: [-122.411, 37.781],
      zoom: 14,
      scrollZoom: false
    });

    const nav = new mapboxgl.NavigationControl({
      showCompass: false
    });
    map.addControl(nav, 'top-left');

    const s = carto.expressions;

    // Define user
    carto.setDefaultAuth({
      username: 'cartovl',
      apiKey: 'default_public'
    });

    // Define layer
    const source = new carto.source.Dataset('sf_crime_2019');

    let days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    const viz = new carto.Viz(`
      @days: ["${days.join('","')}"]
      @count: clusterCount()
      @v_features: viewportFeatures(@count)

      strokeWidth: 0
      width: sqrt(@count)
      color: ramp(clusterMode($incident_day_of_week), bold)
      // color: ramp(buckets(clusterMode($incident_day_of_week), @days), bold)
      resolution: 16

      filter: clusterMode($incident_day_of_week) in @days
      order: asc(width())
    `);

    const LABELS_CONFIG = {
      "id": "my-labels",
      "type": "symbol",
      "source": "labels",
      "layout": {
          "text-field": "{label_field}",
          "text-font": ["Open Sans Semibold", "Arial Unicode MS Regular"],
          "text-size": 10,
          "text-justify": "center"
      },
      "paint": {
          "text-color": "#FFFFFF",
          "text-halo-width": 0,
          "text-halo-blur": 0
      },
      filter: ['!=', ['string', ['get', 'label_field']], '1']
    };

    const layer = new carto.Layer('layer', source, viz);

    layer.addTo(map, 'watername_ocean');
    layer.on('loaded', onLayerLoaded);

    function generateLegend() {
      // Request data for legend from the layer viz
      const legend = layer.viz.color.getLegendData();

      // Create list elements for legend
      const legendList = legend.data.map((legend, index) => {
          const color = rgbToHex(legend.value);
          const key = legend.key.toLowerCase().replace(' ', '-');
          const checked = days.includes(legend.key);

          // Use "js-checkbox" class to get all the checkbox elements from the widget
          // Use "data-days-category" attribute to set the category for each checkbox
          return `
              <li>
                  <input 
                      id="js-checkbox-${key}"
                      class="js-checkbox"
                      type="checkbox"
                      name="categories"
                      data-days-category="${legend.key}"
                  checked>
                  <span class="point-mark" style="background-color:${color};"></span>
                  <label for="js-checkbox-${key}">
                      ${legend.key}
                  </label>
              </li>\n`;
      }).join('');

      document.getElementById('content').innerHTML = legendList;
    }

    function onLayerLoaded() {
      map.addSource('labels', { type: 'geojson', data: null });
      map.addLayer(LABELS_CONFIG);

      const labelSource = map.getSource('labels');
      let initialized = false;
      layer.on('updated', () => {
        if (!initialized) {
            generateLegend();
            setupWidget();
            initialized = true;
        }

        const features = viz.variables.v_features.value;
        updateLabels(features, labelSource);
      });

      hideLoader();
    }

    function updateLabels(features, source) {
      const geojsonFeatures = features.map(feature => {
          return {
              "type": "Feature",
              "geometry": {
                  "type": "Point",
                  "coordinates": feature.getRenderedCentroid()
              },
              "properties": {
                  "label_field": `${feature.properties['count']}`
              }
          }
      });

      source.setData({
          type: 'FeatureCollection',
          features: geojsonFeatures
      });
    }

      function setupWidget() {
          // 1. Get all the category checkboxes
          const checkboxes = document.getElementsByClassName('js-checkbox');
          // 2. Add an event listener to each category checkbox
          for (let i in checkboxes) {
              const checkbox = checkboxes.item(i);
              checkbox.addEventListener('change', toggleCategory);
          };
      }

      function toggleCategory(event) {
          // 1. Get the clicked checkbox element from the event
          const checkboxElement = event.currentTarget;
          // 2. Get the category through the "data-days-category" attribute
          const category = checkboxElement.getAttribute('data-days-category');
          // 3. Toggle the chosen category from the global days array
          days = _toggle(days, category);
          // 4. Check / uncheck the checkbox element
          checkboxElement.checked = days.includes(category);
          // 5. Update the filter
          viz.filter.blendTo(s.in(s.clusterMode(s.prop('incident_day_of_week')), days));
      }

      //** Helper Methods **//

      // A function to convert map colors to HEX values for legend    
      function rgbToHex(color) {
          return "#" + ((1 << 24) + (color.r << 16) + (color.g << 8) + color.b).toString(16).slice(1);
      }

      // A function to toggle an element in an array  
      function _toggle(arr, item) {
          return arr.includes(item) ? arr.filter(i => i !== item) : [...arr, item];
      }

    function hideLoader() {
      document.getElementById('loader').style.opacity = '0';
    }
  </script>
</body>

</html>
